import React, { useState, useMemo, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot } from 'firebase/firestore'; 
import { ShoppingCart, CheckCircle, ChevronLeft, ChevronRight, Lock, User, Mail, Smartphone, Headset, X, ArrowLeft, Loader, Package, RefreshCw, DollarSign, HelpCircle } from 'lucide-react';

// --- Constantes y Datos de Configuraci칩n ---

const BRAND_NAME = "WIN-ANALYST"; 
const MAIN_DISPLAY_TITLE = BRAND_NAME; 
const PLATFORM_NAME = "OVEROPTION"; 

// Nombre del agente de chat
const AGENT_NAME = "Soporte"; 

// Direcci칩n de correo electr칩nico de soporte
const PAYPAL_FALLBACK_LINK = "https://www.paypal.com/ncp/payment/98DJ3XS96TVVJ"; 
const MERCADO_PAGO_COLOMBIA_LINK = "https://mpago.li/1ntePhT"; // Enlace espec칤fico de Mercado Pago para Colombia
const EMAIL_SUPPORT = "soporte@winanalyst.com"; 
// Dominio para el sitio web de T칠rminos y Condiciones
const TERMS_AND_CONDITIONS_URL = "https://www.win-analyst.com/terminos"; 

// Precios y links por pa칤s. ppLink es para PayPal, mpLink es para Mercado Pago.
const PRECIOS = {
  USD: { amount: 25.00, ppLink: PAYPAL_FALLBACK_LINK, mpLink: null }, 
  COP: { amount: 110000.00, ppLink: null, mpLink: MERCADO_PAGO_COLOMBIA_LINK }, 
  MXN: { amount: 460.00, ppLink: PAYPAL_FALLBACK_LINK, mpLink: null },
  ARS: { amount: 20800.00, ppLink: PAYPAL_FALLBACK_LINK, mpLink: null },
  CLP: { amount: 23300.00, ppLink: PAYPAL_FALLBACK_LINK, mpLink: null },
  PEN: { amount: 96.00, ppLink: PAYPAL_FALLBACK_LINK, mpLink: null },
  BRL: { amount: 125.00, ppLink: PAYPAL_FALLBACK_LINK, mpLink: null },
  UYU: { amount: 920.00, ppLink: PAYPAL_FALLBACK_LINK, mpLink: null },
  
  // --- Nuevos Pa칤ses de Centroam칠rica ---
  GTQ: { amount: 195.00, ppLink: PAYPAL_FALLBACK_LINK, mpLink: null }, // Guatemala - Quetzal (equivalente a USD 25)
  CRC: { amount: 12500.00, ppLink: PAYPAL_FALLBACK_LINK, mpLink: null }, // Costa Rica - Col칩n Costarricense (equivalente a USD 25)
  HNL: { amount: 620.00, ppLink: PAYPAL_FALLBACK_LINK, mpLink: null }, // Honduras - Lempira (equivalente a USD 25)
  NIO: { amount: 920.00, ppLink: PAYPAL_FALLBACK_LINK, mpLink: null }, // Nicaragua - C칩rdoba (equivalente a USD 25)
  // El Salvador (SV) y Panam치 (PA) utilizan USD, ya cubierto por la clave USD.
  // ------------------------------------
};

const PRODUCTO = {
  nombre: "RESULTADOS EXACTOS 游댠",
  empresa: BRAND_NAME, 
};

// URLs de Im치genes
const PRODUCT_ICON_URL = "https://placehold.co/48x48/1e40af/ffffff?text=W/A"; 

// Mapeo de pa칤ses
const COUNTRIES_MAP = {
  'AR': { name: 'Argentina', prefix: '+54', flag: '游뷣릖', currency: 'ARS' }, 
  'BR': { name: 'Brasil', prefix: '+55', flag: '游游', currency: 'BRL' }, 
  'CL': { name: 'Chile', prefix: '+56', flag: '游뻟릖', currency: 'CLP' }, 
  'CO': { name: 'Colombia', prefix: '+57', flag: '游뻟릖', currency: 'COP' }, 
  'MX': { name: 'M칠xico', prefix: '+52', flag: '游쓇릖', currency: 'MXN' }, 
  'PE': { name: 'Per칰', prefix: '+51', flag: '游왫릖', currency: 'PEN' }, 
  'UY': { name: 'Uruguay', prefix: '+598', flag: '游쥟릖', currency: 'UYU' }, 
  'VE': { name: 'Venezuela (USD)', prefix: '+58', flag: '游游', currency: 'USD' }, 
  'US': { name: 'Estados Unidos', prefix: '+1', flag: '游쥟릖', currency: 'USD' }, 
  
  // --- Nuevos Pa칤ses de Centroam칠rica ---
  'GT': { name: 'Guatemala', prefix: '+502', flag: '游섫릖', currency: 'GTQ' },
  'CR': { name: 'Costa Rica', prefix: '+506', flag: '游뻟릖', currency: 'CRC' },
  'SV': { name: 'El Salvador', prefix: '+503', flag: '游젏릖', currency: 'USD' }, 
  'HN': { name: 'Honduras', prefix: '+504', flag: '游쇓릖', currency: 'HNL' },
  'NI': { name: 'Nicaragua', prefix: '+505', flag: '游游', currency: 'NIO' },
  'PA': { name: 'Panam치', prefix: '+507', flag: '游왫릖', currency: 'USD' }, 
  // ------------------------------------
};

// Temas de Soporte
const SUPPORT_TOPICS = [
    {
        icon: <RefreshCw className="w-5 h-5 text-red-600 mr-3"/>,
        title: "Devoluciones o Reembolsos",
        responsePurchased: "Hemos recibido su solicitud de reembolso. Por favor, tenga en cuenta que el proceso de revisi칩n y aprobaci칩n tarda de 3 a 5 d칤as h치biles. Si es aprobado, su dinero se ver치 reflejado en su cuenta de 5 a 8 d칤as h치biles adicionales. Le notificaremos por email el resultado.",
        responseNotPurchased: "Para solicitar un reembolso, debe tener una compra registrada. Por favor, contacte a soporte por email si cree que esto es un error."
    },
    {
        icon: <DollarSign className="w-5 h-5 text-yellow-600 mr-3"/>,
        title: "Problemas con el Pago",
        response: "Si experimenta problemas con el pago (error en PayPal o cargo no reflejado), por favor intente los siguientes pasos: 1) Limpie la cach칠 de su navegador. 2) Aseg칰rese de que su cuenta PayPal tenga fondos suficientes o una tarjeta vinculada v치lida. Si el problema persiste, env칤enos una captura del error.",
    },
    {
        icon: <User className="w-5 h-5 text-purple-600 mr-3"/>,
        title: "Acceso al Producto",
        response: `El acceso al producto '${PRODUCTO.nombre}' se env칤a autom치ticamente al *correo electr칩nico* que proporcion칩 en el checkout. Por favor, revise su carpeta de spam o correo no deseado. Si no lo encuentra 30 minutos despu칠s de la compra, cont치ctenos por email con su comprobante de pago.`,
    },
    {
        icon: <HelpCircle className="w-5 h-5 text-gray-600 mr-3"/>,
        title: "Otras Consultas",
        response: "Para consultas generales que no est치n en esta lista, por favor cont치ctenos directamente por correo electr칩nico. Sea lo m치s detallado posible en su pregunta para que podamos brindarle una respuesta precisa.",
    },
];

// --- Funciones Auxiliares ---

/**
 * Funci칩n as칤ncrona para obtener el c칩digo de pa칤s y moneda basado en la IP del usuario.
 * Utiliza un servicio p칰blico de geolocalizaci칩n.
 * @returns {Promise<object>} Objeto con la configuraci칩n del pa칤s.
 */
async function fetchGeolocation() {
    try {
        const response = await fetch('https://ipapi.co/json/'); // Servicio de geolocalizaci칩n IP
        if (!response.ok) throw new Error("API response not OK");
        const data = await response.json();
        
        let countryCode = data.country_code || 'US'; 
        let currencyCode = data.currency || 'USD'; 

        // 1. Verificar si el pa칤s est치 en nuestro mapeo de precios
        if (!COUNTRIES_MAP[countryCode]) {
            // Si el pa칤s no est치 en la lista (ej: Espa침a, Alemania), usamos el USD por defecto
            countryCode = 'US';
            currencyCode = 'USD';
        } else {
             // 2. Asegurarse de que la moneda en nuestra lista coincida con el pa칤s
             currencyCode = COUNTRIES_MAP[countryCode].currency;
        }

        const countryData = COUNTRIES_MAP[countryCode];
        const priceConfig = PRECIOS[currencyCode] || PRECIOS['USD'];

        return {
            country: countryData,
            currency: currencyCode,
            price: priceConfig.amount,
            ppLink: priceConfig.ppLink || PAYPAL_FALLBACK_LINK,
            mpLink: priceConfig.mpLink || null, // Se obtiene el link de MP si aplica (solo para COP)
        };
        
    } catch (e) {
        console.error("Fallo la detecci칩n por IP, usando USD por defecto:", e);
        // Fallback a la configuraci칩n por defecto de Estados Unidos/USD
        const defaultCountry = COUNTRIES_MAP['US'];
        const defaultPriceConfig = PRECIOS['USD'];
        return {
            country: defaultCountry,
            currency: 'USD',
            price: defaultPriceConfig.amount,
            ppLink: defaultPriceConfig.ppLink,
            mpLink: null,
        };
    }
}


const formatCurrency = (amount, currency) => {
    try {
        const localeConfig = {
            'USD': 'en-US', 'COP': 'es-CO', 'MXN': 'es-MX', 'ARS': 'es-AR', 
            'CLP': 'es-CL', 'PEN': 'es-PE', 'EUR': 'es-ES', 'BRL': 'pt-BR', 'UYU': 'es-UY',
            // --- Nuevas Localidades de Centroam칠rica ---
            'GTQ': 'es-GT', 'CRC': 'es-CR', 'HNL': 'es-HN', 'NIO': 'es-NI'
            // ------------------------------------------
        };
        const locale = localeConfig[currency] || 'en-US';

        return new Intl.NumberFormat(locale, { 
            style: 'currency', 
            currency: currency,
            // Las monedas centroamericanas tambi칠n suelen usar dos decimales,
            // pero mantenemos la l칩gica de la original
            minimumFractionDigits: (['COP', 'CLP', 'UYU'].includes(currency)) ? 0 : 2 
        }).format(amount);
    } catch (e) {
        return `${amount.toFixed(2)} ${currency}`;
    }
}

// --- Componente Indicador de Carga ---
const LoadingView = ({ message }) => (
    <div className="p-6 sm:p-8 flex flex-col items-center justify-center text-center h-full min-h-[calc(10vh-84px)] bg-white">
        <Loader className="w-10 h-10 text-blue-600 animate-spin mx-auto mb-4" />
        <p className="text-lg font-medium text-gray-700">{message}</p>
    </div>
);


// --- Componente de Producto Ya Pose칤do ---
const ProductOwnedView = ({ userId, context = 'initial' }) => {
    const title = context === 'repurchase' ? 'Ya Has Adquirido Este Producto' : 'Acceso Verificado';
    const message = context === 'repurchase' ? 
        `Parece que intentas comprar ${PRODUCTO.nombre} de nuevo. Tu acceso ya est치 activo. Si deseas un reembolso, usa el chat de Soporte.` :
        `Ya tienes acceso a **${PRODUCTO.nombre}**. No es necesario volver a comprar.`;

    return (
        <div className="p-6 sm:p-8 flex flex-col items-center justify-center text-center h-full min-h-[calc(10vh-84px)] bg-gray-50">
            <div className="bg-white p-8 rounded-xl shadow-2xl border border-blue-200 w-full max-w-sm">
                <Package className="w-16 h-16 text-blue-600 mx-auto mb-6" />
                <h3 className="text-2xl font-bold text-gray-800 mb-2">{title}</h3>
                <p className="text-base text-gray-600 mb-6">
                    {message}
                </p>
                <div className="bg-blue-50 p-3 rounded-lg border border-blue-200 mb-6">
                    <p className="text-sm font-semibold text-blue-700">
                        Revisa tu email para acceder a los resultados.
                    </p>
                </div>
                <p className="text-xs text-gray-500 mt-6">
                    ID de Sesi칩n (para Soporte): {userId}
                </p>
            </div>
        </div>
    );
};


// --- Componente Indicador de Escritura (Animado) ---
const TypingIndicator = () => (
    <div className="flex items-start justify-start space-x-2 mb-4 animate-pulse">
        <div className="w-8 h-8 rounded-full bg-gray-200 overflow-hidden border border-gray-300 flex items-center justify-center">
             <img src={PRODUCT_ICON_URL} alt="Agent" className="w-full h-full object-cover opacity-70" />
        </div>
        <div className="bg-gray-100 p-3 rounded-xl rounded-tl-none shadow-sm flex items-center space-x-1">
            <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0s' }}></div>
            <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
            <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.4s' }}></div>
        </div>
    </div>
);

// --- Componente Modal de Chat/Soporte ---
const SupportModal = ({ isOpen, onClose, hasPurchased }) => { 
    const [selectedTopic, setSelectedTopic] = useState(null); 
    const [dynamicMessages, setDynamicMessages] = useState([]); 
    const [isAgentTyping, setIsAgentTyping] = useState(false);
    const messagesEndRef = useRef(null);

    useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    }, [dynamicMessages, isAgentTyping]);

    if (!isOpen) return null;

    const handleBackToTopics = () => {
        setSelectedTopic(null);
        setDynamicMessages([]); 
        setIsAgentTyping(false);
    };
    
    const handleTopicClick = (topic) => {
        setSelectedTopic(topic);
        setDynamicMessages([]);
        setIsAgentTyping(true); 

        const userMsg = { sender: 'user', text: `Tengo una consulta sobre: ${topic.title}.` };
        setDynamicMessages([userMsg]);

        const typingDelay = 1500;

        setTimeout(() => {
            setIsAgentTyping(false); 

            if (topic.title === "Devoluciones o Reembolsos") {
                const refundResponse = hasPurchased 
                    ? topic.responsePurchased
                    : topic.responseNotPurchased;

                setDynamicMessages(prev => [...prev, { sender: 'agent', text: refundResponse }]);
                
            } else if (topic.response) {
                setDynamicMessages(prev => [...prev, { sender: 'agent', text: topic.response }]);
            }
        }, typingDelay);
    };
    
    let content;
    let title;
    let headerButton;

    if (selectedTopic) {
        title = selectedTopic.title;
        headerButton = (
            <button onClick={handleBackToTopics} className="text-white hover:text-gray-200 p-1 rounded-full transition flex items-center">
                <ArrowLeft className="w-5 h-5 mr-1"/>
                <span className="text-sm font-semibold hidden sm:inline">Temas</span>
            </button>
        );

        content = (
            <div className="p-4 flex flex-col space-y-4 h-full bg-gray-50">
                <div className="flex-grow overflow-y-auto max-h-[400px] mb-4 space-y-3 pr-1">
                    {dynamicMessages.map((msg, index) => (
                        <div key={index} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'} mb-2`}>
                            {msg.sender === 'agent' && (
                                <div className="w-8 h-8 flex-shrink-0 rounded-full overflow-hidden border border-gray-300 mr-2 mt-1 bg-white">
                                    <img src={PRODUCT_ICON_URL} alt="Agent" className="w-full h-full object-contain p-1" />
                                </div>
                            )}

                            <div className={`p-3 rounded-xl shadow-sm max-w-[85%] text-sm leading-relaxed ${
                                msg.sender === 'user' 
                                    ? 'bg-blue-600 text-white rounded-br-none' 
                                    : 'bg-white text-gray-800 rounded-tl-none border border-gray-200'
                            }`}>
                                {msg.sender === 'agent' && (
                                    <p className="text-xs font-bold text-blue-600 mb-1">{AGENT_NAME}</p>
                                )}
                                 <p dangerouslySetInnerHTML={{ __html: msg.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') }} />
                            </div>
                        </div>
                    ))}
                    {isAgentTyping && <TypingIndicator />}
                    <div ref={messagesEndRef} />
                </div>
                {/* Footer del chat con bot칩n de email: se mantiene el 'mailto:' */}
                <div className="pt-3 border-t border-gray-200 bg-gray-50">
                    <a 
                        href={`mailto:${EMAIL_SUPPORT}?subject=Consulta%20de%20soporte:%20${encodeURIComponent(selectedTopic.title)}`}
                        className="w-full flex items-center justify-center p-3 bg-white border border-blue-200 rounded-lg hover:bg-blue-50 transition duration-150 shadow-sm text-blue-600 font-semibold text-sm"
                    >
                        <Mail className="w-4 h-4 mr-2" />
                        Enviar Email a Soporte
                    </a>
                </div>
            </div>
        );
    } else {
        title = "Atenci칩n al Cliente";
        headerButton = (
            <button onClick={onClose} className="text-white hover:text-gray-200 p-1 rounded-full transition">
                <X className="w-6 h-6"/>
            </button>
        );
        content = (
            <div className="p-5 space-y-4 bg-white rounded-b-xl">
                <p className="text-sm text-gray-600 font-medium mb-2">
                    Selecciona un tema para iniciar el chat:
                </p>
                {SUPPORT_TOPICS.map((topic, index) => (
                    <button
                        key={index}
                        onClick={() => handleTopicClick(topic)}
                        className="w-full flex items-center p-3 bg-gray-50 border border-gray-100 rounded-lg hover:bg-blue-50 hover:border-blue-200 transition duration-150 text-left group"
                    >
                        <div className="p-2 bg-white rounded-full shadow-sm group-hover:shadow-md transition">
                            {topic.icon}
                        </div>
                        <span className="font-semibold text-gray-700 flex-grow ml-3 text-sm">{topic.title}</span>
                        <ChevronRight className="w-4 h-4 text-gray-400 group-hover:text-blue-500"/>
                    </button>
                ))}
                <div className="mt-4 pt-4 border-t border-gray-100 text-center">
                    <p className="text-xs text-gray-400">Horario: 24/7 - Respuestas Autom치ticas</p>
                </div>
            </div>
        );
    }

    return (
        <div 
            className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 transition-opacity duration-300 backdrop-blur-sm"
            onClick={selectedTopic ? (e) => e.stopPropagation() : onClose} 
        >
            <div 
                className="bg-white rounded-xl shadow-2xl w-full max-w-sm m-auto relative flex flex-col overflow-hidden max-h-[600px]"
                onClick={e => e.stopPropagation()} 
            >
                {/* Encabezado del Modal */}
                <div className="p-4 bg-blue-600 text-white flex items-center justify-between shadow-md">
                    <div className="flex items-center space-x-3">
                         <div className="w-8 h-8 rounded-full bg-white p-1 flex items-center justify-center">
                            <img src={PRODUCT_ICON_URL} alt="Logo" className="w-full h-full object-contain p-1" />
                         </div>
                        <div>
                            <h3 className="text-base font-bold leading-tight">{title}</h3>
                            <p className="text-xs text-blue-100 flex items-center"><span className="w-2 h-2 bg-green-400 rounded-full mr-1"></span> En l칤nea</p>
                        </div>
                    </div>
                    {headerButton}
                </div>

                {/* Contenido */}
                <div className="flex-grow overflow-hidden flex flex-col">
                    {content}
                </div>
            </div>
        </div>
    );
}


// --- Componente Modal de T칠rminos y Condiciones ---
const TermsAndConditionsModal = ({ isOpen, onClose }) => {
    if (!isOpen) return null;

    return (
        <div 
            className="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 transition-opacity duration-300 backdrop-blur-sm"
            onClick={onClose} // Cierra el modal al hacer clic en el fondo
        >
            <div 
                className="bg-white p-6 md:p-8 m-4 w-full max-w-3xl max-h-[90vh] rounded-xl shadow-2xl flex flex-col"
                onClick={e => e.stopPropagation()} // Previene el cierre al hacer clic dentro
            >
                <div className="flex justify-between items-center pb-4 border-b border-gray-200 sticky top-0 bg-white z-10">
                    <h2 className="text-2xl font-bold text-gray-800">T칠rminos y Condiciones de Servicio</h2>
   
